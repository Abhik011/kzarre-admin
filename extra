
const ECommerceSection = () => {
  // Navigation states
  const [currentView, setCurrentView] = useState("inventory");
  const [activeTab, setActiveTab] = useState("product");

  // Products
  const [products, setProducts] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  // ðŸ”¹ Fetch products from backend
  const fetchProducts = async () => {
    try {
      setLoading(true);
      const res = await fetch(`${process.env.BACKEND_API_URL}/api/products`);
      const data = await res.json();

      if (data.success && Array.isArray(data.products)) {
        const normalized = data.products.map((p: any) => ({
          id: p._id || p.id,
          name: p.name,
          stock: p.stock ?? 0,
          threshold: p.threshold ?? 10,
          purchase: p.purchasePrice ? `$${p.purchasePrice}` : `$${p.price || 0}`,
          price: p.price ? `$${p.price}` : "$0",
          valuation: p.stock && p.price ? `$${p.stock * p.price}` : "$0",
          supplier: p.vendor || "Unknown",
          status: p.status || "In Stock",
          sku: p.sku || "N/A",
          category: p.category || "Uncategorized",
          image: p.image || "/placeholder.png",
        }));
        setProducts(normalized);
      } else {
        setProducts([]);
      }
    } catch (err) {
      console.error("âŒ Error fetching products:", err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchProducts();
  }, []);

  // Stats
  const stats = {
    totalProducts: products.length,
    totalStock: products.reduce((sum, p) => sum + (p.stock || 0), 0),
    sold: 342,
    returns: 12,
  };

  // Product form state
  type ProductForm = {
    name: string;
    description: string;
    gender: string[];
    basePrice: string;
    sellPrice: string;
    discount: string;
    discountType: "percentage" | "fixed" | string;
    category: string;
    vendor: string;
    tags: string[];
    primaryTag: string;
    secondaryTag: string;
    sku: string;
    barcode: string;
  };

  const [productForm, setProductForm] = useState<ProductForm>({
    name: "",
    description: "",
    gender: [],
    basePrice: "",
    sellPrice: "",
    discount: "",
    discountType: "percentage",
    category: "",
    vendor: "",
    tags: [],
    primaryTag: "",
    secondaryTag: "",
    sku: "",
    barcode: "",
  });

  const [variants, setVariants] = useState<any[]>([]);
  const [newVariant, setNewVariant] = useState({
    size: "",
    color: "",
    material: "",
    lowStockAlert: "",
    stock: "",
    barcode: "",
  });

  const [showAddVariant, setShowAddVariant] = useState(false);
  const [uploadedImages, setUploadedImages] = useState<
    { id: number; url: string | ArrayBuffer | null; name: string }[]
  >([]);
  const [selectedImage, setSelectedImage] = useState(0);
  const [realFiles, setRealFiles] = useState<File[]>([]);
  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const [isDragging, setIsDragging] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);

  // ðŸ§© Handle product form inputs
  const handleProductInputChange = (field: string, value: any) =>
    setProductForm((prev) => ({ ...prev, [field]: value }));

  const handleGenderChange = (gender: string) =>
    setProductForm((prev) => ({
      ...prev,
      gender: prev.gender.includes(gender)
        ? prev.gender.filter((g) => g !== gender)
        : [...prev.gender, gender],
    }));

  // ðŸ§© File upload (drag/drop + browse)
  const handleMultipleFileUpload = (files: FileList | File[]) => {
    const newImages: { id: number; url: string | ArrayBuffer | null; name: string }[] = [];
    const fileArray = Array.from(files);
    const totalFiles = fileArray.length;

    fileArray.forEach((file) => {
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = (e) => {
          newImages.push({ id: Date.now() + Math.random(), url: e.target?.result || "", name: file.name });
          if (newImages.length === totalFiles) {
            setUploadedImages((prev) => [...prev, ...newImages]);
          }
        };
        reader.readAsDataURL(file);
      }
    });
    setRealFiles((prev) => [...prev, ...fileArray]);
  };

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) handleMultipleFileUpload(files);
  };

  // ðŸ§© Handle save (upload to backend)
  const handleSaveProduct = async () => {
    try {
      if (!productForm.name || !productForm.category)
        return alert("Please fill in product name and category.");
      if (!realFiles.length) return alert("Please upload at least one image.");

      const formData = new FormData();
      formData.append("name", productForm.name);
      formData.append("description", productForm.description);
      formData.append("price", productForm.sellPrice);
      formData.append("category", productForm.category);
      formData.append("vendor", productForm.vendor);
      formData.append("tags", JSON.stringify(productForm.tags || []));
      formData.append("gender", JSON.stringify(productForm.gender || []));
      formData.append("variants", JSON.stringify(variants || []));
      realFiles.forEach((file) => formData.append("images", file));

      const token = localStorage.getItem("token") || "";
      setUploading(true);
      setUploadProgress(0);

      await new Promise<void>((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const apiUrl = `${process.env.BACKEND_API_URL}/api/products/upload`;
        xhr.open("POST", apiUrl, true);
        if (token) xhr.setRequestHeader("Authorization", `Bearer ${token}`);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) setUploadProgress(Math.round((e.loaded / e.total) * 100));
        };

        xhr.onload = async () => {
          setUploading(false);
          setUploadProgress(100);
          if (xhr.status === 200 || xhr.status === 201) {
            await fetchProducts();
            resetForm();
            setCurrentView("inventory");
            resolve();
          } else reject(new Error("Upload failed"));
        };

        xhr.onerror = () => reject(new Error("Network error"));
        xhr.send(formData);
      });
    } catch (err) {
      console.error("Upload error:", err);
      alert("Error uploading product.");
    } finally {
      setUploading(false);
      setUploadProgress(0);
    }
  };

  // ðŸ§© Reset form
  const resetForm = () => {
    setProductForm({
      name: "",
      description: "",
      gender: [],
      basePrice: "",
      sellPrice: "",
      discount: "",
      discountType: "percentage",
      category: "",
      vendor: "",
      tags: [],
      primaryTag: "",
      secondaryTag: "",
      sku: "",
      barcode: "",
    });
    setVariants([]);
    setUploadedImages([]);
    setRealFiles([]);
    setSelectedImage(0);
  };

  // ðŸ§© Inventory UI
  const renderInventory = () => (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {[
          { label: "Total Products", value: stats.totalProducts, icon: Package },
          { label: "Total Stock", value: stats.totalStock, icon: Box },
          { label: "Sold", value: stats.sold, icon: ShoppingCart },
          { label: "Returns", value: stats.returns, icon: RotateCcw },
        ].map((item, i) => (
          <div key={i} className="bg-white rounded-xl p-6 border border-gray-200 flex justify-between items-center">
            <div>
              <div className="text-gray-600 text-sm">{item.label}</div>
              <div className="text-2xl font-bold text-gray-900">{item.value}</div>
            </div>
            <item.icon className="text-gray-400" size={22} />
          </div>
        ))}
      </div>

      <div className="bg-white rounded-xl border border-gray-200">
        <div className="p-6 border-b border-gray-200 flex justify-between">
          <h2 className="text-xl font-semibold text-gray-900">Product List</h2>
          <div className="flex items-center gap-3">
            <Filter size={20} className="text-gray-600 cursor-pointer" />
            <Download size={20} className="text-gray-600 cursor-pointer" />
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-gray-200 bg-gray-50">
                {["Product", "Stock", "Threshold", "Purchase", "Price", "Valuation", "Supplier", "Actions"].map((h) => (
                  <th key={h} className="px-6 py-4 text-left text-sm font-semibold text-gray-900">
                    {h}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {loading ? (
                <tr>
                  <td colSpan={8} className="text-center py-6 text-gray-500">
                    Loading products...
                  </td>
                </tr>
              ) : products.length === 0 ? (
                <tr>
                  <td colSpan={8} className="text-center py-6 text-gray-500">
                    No products found.
                  </td>
                </tr>
              ) : (
                products.map((p) => (
                  <tr key={p.id} className="border-b border-gray-200 hover:bg-gray-50">
                    <td className="px-6 py-4 flex items-center gap-3">
                      <img src={p.image} alt={p.name} className="w-10 h-10 rounded-md object-cover" />
                      <div>
                        <div className="font-medium">{p.name}</div>
                        <div className="text-xs text-gray-500">SKU: {p.sku}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4 text-sm">{p.stock}</td>
                    <td className="px-6 py-4 text-sm">{p.threshold}</td>
                    <td className="px-6 py-4 text-sm">{p.purchase}</td>
                    <td className="px-6 py-4 text-sm">{p.price}</td>
                    <td className="px-6 py-4 text-sm">{p.valuation}</td>
                    <td className="px-6 py-4 text-sm">{p.supplier}</td>
                    <td className="px-6 py-4">
                      <MoreVertical size={18} className="text-gray-500" />
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
